<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BrainstormQ</title>
    <link rel="stylesheet" href="stylesheet.css">
    <script src="th-api.js"></script>

</head>
<body onload="loadLeaderboard()">
    <!-- top navigation menu -->
    <div class="topnav" id="topnav">

    <a href="javascript:getChallenges(this);" id="refresh" class="refresh">Refresh</a>
    <button id="homeBtn" class="homeBtn" onclick="window.location.href='index.html'" >Home</button>
    <button id="restartBtn" class="restartBtn" onclick="window.location.href='app.html'" >Restart</button>
    <!-- Trigger/Open The Modal -->
    <button id="infoBtn" class="infoBtn" >Info</button>

</div>

    <!-- The Modal -->
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <p style="color:darksalmon">Enter your name and get started with the questions!</p>
            <ul class="pointsModal">

                <li>If your answer is <span style="color: green">correct</span> you are rewarded with 10 points.</li>
                <li>If your answer is <span style="color:red"> wrong </span>you lose  3 points.</li>
                <li>If you <span style="color:red">skip</span> a question you lose 5 points.</li>

            </ul>

            <p style="color:darksalmon">When the quiz is over you will be directed to the leaderboards.</p>
        </div>

    </div>

    <!-- Leaderboard section -->
    <div class="leaderboardContainer" id="leaderboardContainer">
        <div class="refreshBtnContainer" id="refreshBtnContainer">
            <button type="submit" class="refreshBtn" id="refreshBtn" onclick="refreshLeaderboard()">Refresh</button>
        </div>

        <div class="leaderboardsHeader" id="leaderboardHeader">

        </div>

        <div class="hasPrizeContainer" id="hasPrizeContainer">
            <h3>Congratulations you have won a <span>prize</span></h3>
        </div>
        <h3 class="loading" id="loading"></h3>
        <div class="tableContainer" id="tableContainer">
            <table class="leaderboardTable" id="leaderboardTable">
                <tr>
                    <th>Name</th>
                    <th>Score</th>
                    <th>Completion Date</th>
                </tr>
            </table>
        </div>

    </div>

    <script>
        // Get the modal
        let modal = document.getElementById("myModal");

        // Get the button that opens the modal
        let btn = document.getElementById("infoBtn");

        // Get the <span> element that closes the modal
        let span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }


        function convertMsToDate(startsOnString){
            let startsOnNum = Number(startsOnString); //actually didnt need to convert
            let options = {
                year: 'numeric', month: 'numeric', day: 'numeric',
            };
            let date = new Date(startsOnNum);
            let result = date.toLocaleDateString('en', options); // month/day/year
            return result;
        }

        function loadLeaderboard(){

           // document.getElementById("questionMessage").innerText="";
            //document.getElementById("skip").style.visibility="hidden";
           // document.getElementById("scoreContainer").style.display="none";
           // document.getElementById("questionIndexContainer").style.display="none";
            document.getElementById("loading").innerText="Loading...";
           // QRContainer.style.display="none";


            fetch(TH_BASE_URL_LEADERBOARDS+getCookie("sessionID")+"&sorted&limit=40")
                .then(response => response.json()) //Parse JSON text to JavaScript object
                .then(jsonObject => {
                    document.getElementById("loading").innerText="";
                    document.getElementById("leaderboardHeader").style.display="block";
                    document.getElementById("tableContainer").style.display="block";
                    document.getElementById("refreshBtnContainer").style.display="block";
                    if(jsonObject.status==="OK") {
                        let tableContents = "";
                        getRank();//get ranking of player
                        if(jsonObject.hasPrize===true){
                            document.getElementById("hasPrizeContainer").style.display="block";
                        }

                        const leaderboardArray = jsonObject.leaderboard;

                        for (let i = 0; i < leaderboardArray.length; i++) {
                            const entry = leaderboardArray[i];
                            const playerName = entry.player;
                            const score = entry.score;
                            const completionTime = entry.completionTime;

                            tableContents += "<tr>\n" +
                                "    <td>" + playerName + "</td>" +
                                "    <td>" + score + "</td>" +
                                "    <td>" + convertMsToDate(completionTime) + "</td>" +
                                "</tr>";
                        }
                        document.getElementById("leaderboardTable").innerHTML += tableContents;
                    }
                    else if(jsonObject.status==="ERROR"){
                        let errorMessage = confirm(jsonObject.errorMessages[0])
                        if (errorMessage)
                            window.location.href = "app.html";
                    }
                });


        }

        /*Refreshes the leaderboards */
        function refreshLeaderboard(){
            document.getElementById("leaderboardTable").innerHTML="";
            document.getElementById("leaderboardHeader").innerHTML="";
            document.getElementById("refreshBtnContainer").style.display="none";
            loadLeaderboard();
        }

        function getRank(){
            let rankCounter=0;
            let header;
            fetch( TH_BASE_URL_LEADERBOARDS+ getCookie("sessionID") + "&sorted&limit=2000")
                .then(response => response.json())
                .then(jsonObject => {
                    let name = getCookie("playerNameCookie");
                    const leaderboardArray = jsonObject.leaderboard;
                    for (let i = 0; i < leaderboardArray.length; i++) {
                        const entry = leaderboardArray[i];
                        const playerName = entry.player;
                        const score = entry.score;
                        const completionTime = entry.completionTime;
                        if(playerName===getCookie("playerNameCookie")){
                            header="<h3>"+"Congratulations "+getCookie("playerNameCookie")+" you managed to finished the "+getCookie("nameOfGame")+ " and your rank is " + rankCounter+ "</h3>";
                            document.getElementById("leaderboardHeader").innerHTML+=header;
                        }
                        else{
                            rankCounter++;
                        }

                    }
                });
        }
    </script>
</body>
</html>