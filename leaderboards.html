<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BrainstormQ</title>
    <link rel="stylesheet" href="stylesheet.css">
</head>
<body onload="checkForTest()">
    <!-- top navigation menu -->
    <div class="topnav" id="topnav">

    <a href="javascript:getChallenges(this);" id="refresh" class="refresh">Refresh</a>
    <button id="homeBtn" class="homeBtn" onclick="window.location.href='index.html'" >Home</button>
    <button id="restartBtn" class="restartBtn" onclick="window.location.href='SignIn.html'" >Restart</button>
    <!-- Trigger/Open The Modal -->
    <button id="infoBtn" class="infoBtn" >Info</button>

</div>

    <!-- The Modal -->
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <p style="color:darksalmon">Enter your name and get started with the questions!</p>
            <ul class="pointsModal">

                <li>If your answer is <span style="color: green">correct</span> you are rewarded with 10 points.</li>
                <li>If your answer is <span style="color:red"> wrong </span>you lose  3 points.</li>
                <li>If you <span style="color:red">skip</span> a question you lose 5 points.</li>

            </ul>

            <p style="color:darksalmon">When the quiz is over you will be directed to the leaderboards.</p>
        </div>

    </div>

    <!-- Leaderboard section -->
    <div class="leaderboardContainer" id="leaderboardContainer">
        <div class="refreshBtnContainer" id="refreshBtnContainer">
            <button type="submit" class="refreshBtn" id="refreshBtn" onclick="refreshLeaderboard()">Refresh</button>
        </div>

        <div class="scoreDisplay" id="scoreDisplay"></div>

        <div class="hasPrizeContainer" id="hasPrizeContainer">
            Congratulations you have won a prize
        </div>
        <h3 class="loading" id="loading"></h3>
        <div class="tableContainer" id="tableContainer">
            <table class="leaderboardTable" id="leaderboardTable">
                <tr>
                    <th>Name</th>
                    <th>Score</th>
                    <th>Completion Date</th>
                </tr>
            </table>
        </div>

    </div>

    <script>
        const params = new URLSearchParams(location.search);
        const TH_TEST_URL = "https://codecyprus.org/th/test-api/"; // the test API base url
        const TH_BASE_URL_LEADERBOARDS="https://codecyprus.org/th/api/leaderboard?session=";
        const TH_BASE_URL_SCORE="https://codecyprus.org/th/api/score?session="; // the true API base url for score


        // Get the modal
        let modal = document.getElementById("myModal");

        // Get the button that opens the modal
        let btn = document.getElementById("infoBtn");

        // Get the <span> element that closes the modal
        let span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }


        function checkForTest(){
            checkForTestLB();
            checkForTestScore();
        }

        function checkForTestLB(){
            if(testLB()){
                document.getElementById("scoreDisplay").style.display="none";
                document.getElementById("refreshBtnContainer").style.display="none";
                let testPrize=params.has("hasPrize");
                let testSorted=params.has("sorted");
                let testNumOfPlayers=params.get("size");
                let url=TH_TEST_URL+"leaderboard?"+"sorted="+testSorted+"&hasPrize="+testPrize+"&size="+testNumOfPlayers;
                loadLeaderboard(url);
            }
            else if(!testLB() && !testSc()){
                let url=TH_BASE_URL_LEADERBOARDS+getCookie("sessionID")+"&sorted&limit=40";
                loadLeaderboard(url);
            }
        }

        function checkForTestScore(){
            if(testSc()){
                document.getElementById("leaderboardTable").style.display="none";
                document.getElementById("refreshBtnContainer").style.display="none";
                let testScore=params.get("score");
                let testCompleted=params.has("completed");
                let url=TH_TEST_URL+"score?"+"score="+testScore+"&completed="+testCompleted;
                setTimeout(score(url),2000);
            }
            else if(!testSc() && !testLB()){
                let url=TH_BASE_URL_SCORE+getCookie("sessionID");
                setTimeout(score(url),2000);
            }
        }

        function testLB(){
             let url = new URL(window.location.href);
            return url.searchParams.get("testLB")!=null;
        }

        function testSc(){
            let url = new URL(window.location.href);
            return url.searchParams.get("testSc")!=null;
        }

        function convertMsToDate(startsOnString){
            let startsOnNum = Number(startsOnString); //actually didnt need to convert
            let options = {
                year: 'numeric', month: 'numeric', day: 'numeric',
            };
            let date = new Date(startsOnNum);
            let result = date.toLocaleDateString('en', options); // month/day/year
            return result;
        }

        function loadLeaderboard(url){
            document.getElementById("loading").innerText="Loading...";
            fetch(url)
                .then(response => response.json()) //Parse JSON text to JavaScript object
                .then(jsonObject => {
                    document.getElementById("loading").innerText="";
                    if(jsonObject.status==="OK") {
                        let tableContents = "";

                        if (jsonObject.hasPrize === true) {
                            document.getElementById("hasPrizeContainer").style.display = "block";
                        }
                        const leaderboardArray = jsonObject.leaderboard;

                        for (let i = 0; i < leaderboardArray.length; i++) {
                            const entry = leaderboardArray[i];
                            const playerName = entry.player;
                            const score = entry.score;
                            const completionTime = entry.completionTime;

                            tableContents += "<tr>\n" +
                                "    <td>" + playerName + "</td>" +
                                "    <td>" + score + "</td>" +
                                "    <td>" + convertMsToDate(completionTime) + "</td>" +
                                "</tr>";
                        }
                        document.getElementById("leaderboardTable").innerHTML += tableContents;
                        if(!testLB() && !testSc()){
                            document.getElementById("refreshBtnContainer").style.display="block";
                        }
                    }
                    else if(jsonObject.status==="ERROR"){
                        let errorMessage = confirm(jsonObject.errorMessages[0]);
                        if (errorMessage)
                            window.location.href = "app.html";
                    }
                });
            const deleteCookies = function(){

                //https://stackoverflow.com/questions/179355/clearing-all-cookies-with-javascript
                var cookies = document.cookie.split("; ");
                for (var c = 0; c < cookies.length; c++) {
                    var d = window.location.hostname.split(".");
                    while (d.length > 0) {
                        var cookieBase = encodeURIComponent(cookies[c].split(";")[0].split("=")[0]) + '=; expires=Thu, 01-Jan-1970 00:00:01 GMT; domain=' + d.join('.') + ' ;path=';
                        var p = location.pathname.split('/');
                        document.cookie = cookieBase + '/';
                        while (p.length > 0) {
                            document.cookie = cookieBase + p.join('/');
                            p.pop();
                        };
                        d.shift();
                    }
                }
            };
            setTimeout(deleteCookies, 2000);

        }

        /*Refreshes the leaderboards */
        function refreshLeaderboard(){
            document.getElementById("leaderboardTable").innerHTML="";
            document.getElementById("scoreDisplay").innerHTML="";
            document.getElementById("refreshBtnContainer").style.display="none";
            checkForTestLB();
            checkForTestScore();
        }

        function getRank(){
            let rankCounter=0;
            let rankDisplay=document.getElementById("rankDisplay"); //test
            fetch( TH_BASE_URL_LEADERBOARDS+ getCookie("sessionID") + "&sorted&limit=2000")
                .then(response => response.json())
                .then(jsonObject => {
                    let name = getCookie("playerNameCookie");
                    let leaderboardArray = jsonObject.leaderboard;
                    for (let i = 0; i < leaderboardArray.length; i++) {
                        const entry = leaderboardArray[i];
                        const playerName = entry.player;
                        const score = entry.score;
                        const completionTime = entry.completionTime;
                        if(playerName===getCookie("playerNameCookie")){
                            rankDisplay.innerHTML=" and your rank is "+rankCounter;
                        }
                        else{
                            rankCounter++;
                        }

                    }
                });
        }

        function score(url){
            let completedLB="";
            fetch(url)
                .then(response => response.json())
                .then(jsonObject => {
                    if(jsonObject.status === "OK"){
                        if((jsonObject.completed === false) && (jsonObject.finished === false)){
                            completedLB="is not completed ";
                            document.getElementById("scoreDisplay").innerHTML="The game "+completedLB + jsonObject.player+", and your score is "+jsonObject.score+" points."
                        }
                        else if(jsonObject.completed === true){
                            completedLB="is completed ";
                            document.getElementById("scoreDisplay").innerHTML="Congratulations the game "+completedLB + jsonObject.player+", and your score is "+jsonObject.score+
                            "<span id='rankDisplay'></span>";
                            getRank();
                        }
                    }
                    else{
                        let errorMessage = confirm(jsonObject.errorMessages[0]);
                        if (errorMessage) window.location.href = "SignIn.html";
                        else  window.location.href = "SignIn.html";
                    }
                });
        }

        function getCookie(cookieName) {
            let name = cookieName + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) === 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function saveCookie(cookieName, cookieValue,cookieLifespan) {
            let date = new Date();
            date.setTime(date.getTime() + (cookieLifespan * 60 * 60 * 1000));
            let expires = "expires=" + date.toUTCString();
            document.cookie = cookieName + "=" + cookieValue + ";" + expires;
        }

    </script>




</body>
</html>